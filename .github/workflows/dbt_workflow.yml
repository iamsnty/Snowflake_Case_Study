name: Run dbt Transform + Publish Pipeline

on:
 push:
  branches: [ main ]
 pull_request:
  branches: [ main ]
 workflow_dispatch: # allows manual trigger from Actions tab

jobs:
 run-dbt:
  name: Run dbt Transform + Publish
  runs-on: ubuntu-latest

  steps:
   - name: Checkout repository
    uses: actions/checkout@v4

   - name: Set up Python
    uses: actions/setup-python@v5
    with:
     python-version: "3.9"

   - name: Install dbt Snowflake adapter
    run: |
     python -m pip install --upgrade pip
     pip install dbt-snowflake

   - name: Verify dbt installation
    run: dbt --version

   - name: Create dbt profiles.yml
    run: |
     mkdir -p ~/.dbt
     cat <<EOF > ~/.dbt/profiles.yml
     dbt_tf:
      target: dev_stg
      outputs:
       dev_stg:
        type: snowflake
        account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        user: ${{ secrets.SNOWFLAKE_USER }}
        password: ${{ secrets.SNOWFLAKE_PASSWORD }}
        role: ${{ secrets.SNOWFLAKE_ROLE }}
        warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        database: ${{ secrets.SNOWFLAKE_DATABASE }}
        schema: TRANSFORM_SCH
        threads: 8
       dev_mrt:
        type: snowflake
        account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        user: ${{ secrets.SNOWFLAKE_USER }}
        password: ${{ secrets.SNOWFLAKE_PASSWORD }}
        role: ${{ secrets.SNOWFLAKE_ROLE }}
        warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        database: ${{ secrets.SNOWFLAKE_DATABASE }}
        schema: MART_SCH
        threads: 8
     EOF

   - name: Install dbt dependencies
    run: dbt deps

   - name: Run Transform layer (dev_stg)
    run: |
     echo ":building_construction: Running TRANSFORM layer models..."
     dbt run --target dev_stg --select models/transform
     dbt test --target dev_stg --select models/transform

   - name: Run Publish layer (dev_mrt)
    run: |
     echo ":rocket: Running PUBLISH layer models..."
     dbt run --target dev_mrt --select models/publish
     dbt test --target dev_mrt --select models/publish

   - name: Generate dbt docs (optional)
    run: dbt docs generate
